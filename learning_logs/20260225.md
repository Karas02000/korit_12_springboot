# ì…ì‹¤ ì²´í¬ í•´ì£¼ì„¸ìš” !! ğŸˆ

## ê¸ˆì¼ ìˆ˜ì—… ê³„íš
1. JWT

## JWTë¡œ ë°±ì—”ë“œ ë³´í˜¸í•˜ê¸°
- ì–´ì œê¹Œì§€ì˜ ìˆ˜ì—…ì—ì„œ RESTful ì›¹ ì„œë¹„ìŠ¤ì—ì„œì˜ ê¸°ë³¸ ì¸ì¦(postman ìƒì—ì„œ basic auth)ì„ ì´ìš©í•˜ëŠ” ë°©ë²•ì„ í•™ìŠµí–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ì¸ì¦ì´ë€ í† í°ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì„¸ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì´ í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•´ë‹¹ ë°©ì‹ì€ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•  ë•Œ ê° ìš”ì²­ê³¼ í•¨ê»˜ ìê²© ì¦ëª…ì´ í•¨ê»˜ ì „ì†¡ë˜ë¯€ë¡œ ë³´ì•ˆ ìƒì˜ ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  í•´ë‹¹ ë°©ì‹ì€ ë¦¬ì•¡íŠ¸ë¡œ ìì²´ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ê°œë°œí•  ë•Œ ì´ìš©í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤. ëŒ€ì‹  JWTë¥¼ ì´ìš©í•œ ì¸ì¦ ë°©ë²•ì„ ì‚¬ìš©í•  ì˜ˆì •ì…ë‹ˆë‹¤.

### JWT ë€ ?
- ì¸ì¦ êµ¬í˜„ ë°©ë²• ì¤‘ í•˜ë‚˜, ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬(Authentication & Authorization) ëª©ì ìœ¼ë¡œ RESTful APIì—ì„œ ê°€ì¥ ë³´í¸ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
- ì¸ì¦(Authentication) : ë³´í†µ ë¡œê·¸ì¸ ê³¼ì •ê³¼ ê´€ë ¨
- ì¸ê°€/ê¶Œí•œë¶€ì—¬(Authorization) : íŠ¹ì • ì—­í• ì´ íŠ¹ì • í˜ì´ì§€ë¥¼ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ”ì§€ ì—†ëŠ”ì§€ì— ì—¬ë¶€
    - ì¦‰, ì¸ì¦ì€ ë°›ì•˜ê¸° ë•Œë¬¸ì— ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•˜ê¸´ í•˜ì§€ë§Œ, íšŒì›ì´ ë‹¤ë¥¸ íšŒì›ì„ ì‚­ì œí•  ê¶Œí•œì€ ì—†ëŠ” ë°˜ë©´ì—, ê´€ë¦¬ìëŠ” ë‹¤ë¥¸ íšŒì›ì„ ì¡°íšŒí•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ê¶Œí•œì„ ê°€ì§ˆ ìˆ˜ë„ ìˆìŒ. ì¦‰, ì¸ì¦ ì´í›„ì˜ íŠ¹ì • HTTP ìš”ì²­ì— ê´€í•œ ê¶Œí•œì— ê°€ê¹ìŠµë‹ˆë‹¤.
- JWT ìì²´ëŠ” í¬ê¸°ê°€ ë§¤ìš° ì‘ê¸° ë•Œë¬¸ì— URL / POST ë§¤ê°œë³€ìˆ˜ ë˜ëŠ” í—¤ë” ë‚´ë¶€ì— ë‹´ì•„ì„œ ì „ì†¡í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë³¸ì‹œ ìˆ˜ì—… ì¤‘ì—ëŠ” postman ìƒì—ì„œì˜ ìš”ì²­ì„ í•  ë•Œ ì˜ˆì‹œë¥¼ ì œê³µ ì˜ˆì •.
- JWT ë‚´ë¶€ì—ëŠ” ì‚¬ìš©ì ì´ë¦„ê³¼ ì—­í•  ë“± í•„ìˆ˜ì ì¸ ì •ë³´ë¥¼ ë‹´ëŠ” ê²ƒì´ ê°€ëŠ¥
### JWTì˜ êµ¬ì¡°
![alt text](JWT-êµ¬ì¡°.png)
- header : í† í°ì˜ ìœ í˜•ê³¼ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ì •ì˜
- payload : ì¸ì¦ì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ í¬í•¨.
- signiture : í† í°ì´ ë„ì¤‘ì— ë³€ê²½ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë° ì´ìš©
![](img_jwt.png)
- ì´ìƒì˜ ì´ë¯¸ì§€ì—ì„œ '.' ì„ ê¸°ì¤€ìœ¼ë¡œ header / payload / signitureê°€ ë¶„ë¦¬ë©ë‹ˆë‹¤. 
- JWTëŠ” ì¸ì¦ì— ì„±ê³µí•œ í›„ í´ë¼ì´ì–¸íŠ¸ê°€ ì „ì†¡í•˜ëŠ” ìš”ì²­ì—ëŠ” í•­ìƒ ì¸ì¦ ì‹œ ë°›ì€ JWTê°€ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
### JWT ìƒì„± ë° í•´ì„ê³¼ ì‘ìš© ê³¼ì •
1. build.gradleì— ì˜ì¡´ì„± ì¶”ê°€
```java
	implementation 'io.jsonwebtoken:jjwt-api:0.13.0'
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.13.0'
	runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.13.0'
```

2. ì„œëª…ëœ JWTë¥¼ ìƒì„±í•˜ê³  ê²€ì¦í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤. service íŒ¨í‚¤ì§€ ë‚´ì— JwtServiceë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ì‹œì˜¤.

```java
package com.korit12.cardatabase.service;

import org.springframework.stereotype.Service;

@Service
public class JwtService {
    // 1ì¼(ë°€ë¦¬ì´ˆ ê¸°ì¤€) - ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ì¢€ ë” ì§§ê²Œ ì¡ìŠµë‹ˆë‹¤
    static final long EXPIRATIONTIME = 86400000;
    static final String PREFIX = "Bearer";
}
```
- PREFIXëŠ” í† í°ì˜ ì ‘ë‘ì‚¬ë¥¼ ì˜ë¯¸í•˜ë©°, ì¼ë°˜ì ìœ¼ë¡œ "Bearer" ìŠ¤í‚¤ë§ˆê°€ ì‚¬ìš©ë©ë‹ˆë‹¤. JWT Authorization í—¤ë”ì— ë‹´ê²¨ì„œ ì „ì†¡ë˜ë©°, Bearer ìŠ¤í‚¤ë§ˆë¥¼ ì´ìš©í•˜ëŠ” ê²½ìš° í—¤ë”ì˜ ë‚´ìš©ì€ ì´í•˜ì™€ ê°™ìŠµë‹ˆë‹¤.

`Authorization: Bearer <token>`

3. jjwt ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì˜ secretKeyFor() ë©”ì„œë“œë¥¼ í™œìš©í•˜ì—¬ ë¹„ë°€ í‚¤ë¥¼ ìƒì„±í• ê²ë‹ˆë‹¤. ì‹œì—°ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ê³  ì‹¤ì œ ìš´ì˜í™˜ê²½ì—ì„œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì„±ì—ì„œ ë¹„ë°€ í‚¤ë¥¼ ì½ì–´ì•¼ í•©ë‹ˆë‹¤. ì´í›„ getToken() ë©”ì„œë“œê°€ í† í°ì„ ìƒì„±í•˜ê³  returní• ê²ë‹ˆë‹¤. getAuthUser() ë©”ì„œë“œë¥¼ í†µí•´ ì‘ë‹µì˜ Authorization í—¤ë”ì—ì„œ í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ê·¸ë¦¬ê³  parser() ë©”ì„œë“œë¥¼ í†µí•´ JwtParser ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í• ê²ë‹ˆë‹¤. setSigningKey() ë©”ì„œë“œë¥¼ í†µí•´ í† í° í™•ì¸ì„ ìœ„í•œ ë¹„ë°€ í‚¤ë¥¼ ì§€ì •í•˜ëŠ” ë° ì´ìš©í• ê±°ê³ , parseClaimsJws() ë©”ì„œë“œë¥¼ í†µí•´ Authorization í—¤ë”ì—ì„œ Bearer ì ‘ë‘ì‚¬ë¥¼ ë˜ ì œê±°í• ê²ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ getSubject() ë©”ì„œë“œë¥¼ ì´ìš©í•˜ì—¬ ì‚¬ìš©ì ì´ë¦„ì„ ê°€ì ¸ì˜¬ê²ë‹ˆë‹¤.

ì „ì²´ ì½”ë“œëŠ” ì´í•˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```java
package com.korit12.cardatabase.service;

import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.http.HttpHeaders;
import org.springframework.stereotype.Service;

import javax.crypto.SecretKey;
import java.util.Date;

@Service
public class JwtService {
    // 1ì¼(ë°€ë¦¬ì´ˆ ê¸°ì¤€) - ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ì¢€ ë” ì§§ê²Œ ì¡ìŠµë‹ˆë‹¤
    static final long EXPIRATIONTIME = 86400000;
    static final String PREFIX = "Bearer ";

    static final SecretKey KEY = Keys.secretKeyFor(SignatureAlgorithm.HS256);

    // í† í° ìƒì„±
    public String getToken(String username) {
        return Jwts.builder()
                .subject(username)
                .expiration(new Date(System.currentTimeMillis() + EXPIRATIONTIME))
                .signWith(KEY)
                .compact();
    }

    // í† í° ê²€ì¦ ë° username ì¶”ì¶œ
    public String getAuthUser(HttpServletRequest request) {
        String token = request.getHeader(HttpHeaders.AUTHORIZATION);

        if (token != null && token.startsWith(PREFIX)) {
            // "Bearer " ì ‘ë‘ì‚¬ë¥¼ ì œê±°í•˜ëŠ” ê³¼ì •
            String authToken = token.substring(PREFIX.length()).trim();

            String user = Jwts.parser()
                    .verifyWith(KEY)
                    .build()
                    .parseSignedClaims(authToken)
                    .getPayload()
                    .getSubject();

            if(user != null) {
                return user;
            }
        }
        return null;
    }
}
```

- jjwtì˜ ë²„ì „ì´ 12 ì´í›„ë¡œ ë°”ë€œì— ë”°ë¼ ì›ë˜ëŠ” parserBuilder()ë¼ê³ í•˜ëŠ” ë©”ì„œë“œì˜€ë‹¤ê°€ parse()ë¡œ ë³€ê²½ì´ ë˜ì—ˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ íŠ¹ì • ë²„ì „ì„ ì´ìš©í•´ì•¼í•˜ëŠ” ê²½ìš°ë„ ìˆì–´ì„œ ì§€ë‚œ ê¸°ìˆ˜ê¹Œì§€ëŠ” 11ë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œí–ˆì—ˆìœ¼ë‚˜ ì´ë²ˆì—ëŠ” ìµœì‹  ìœ„ì£¼ë¡œ ê°€ê³  ìˆìŠµë‹ˆë‹¤.

4. ë‹¤ìŒìœ¼ë¡œ ì¸ì¦ì„ ìœ„í•œ ìê²© ì¦ëª…ì„ ì €ì¥í•˜ëŠ” ìƒˆë¡œìš´ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í• ê²ë‹ˆë‹¤. ì—¬ê¸°ì„œ ë˜ ìƒˆë¡œìš´ ìë£Œí˜• í•™ìŠµí• ê²ë‹ˆë‹¤. Recordë¼ê³  í•˜ëŠ” ìë£Œí˜•ì„ ìƒì„±. RecordëŠ” ë°ì´í„°ë§Œ ë³´ê´€í•˜ëŠ” í´ë˜ìŠ¤ê°€ í•„ìš”í•  ë•Œ ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ë¥¼ ì•ˆ ì¨ë„ ë˜ëŠ” ìë£Œí˜•ìœ¼ë¡œ Java14ì—ì„œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
    - domain íŒ¨í‚¤ì§€ ë‚´ì— AccountCredentials ìƒì„±
```java
package com.korit12.cardatabase.domain;

public record AccountCredentials(String username, String password) {
}
```
5. Loginì„ ìœ„í•œ Controller í´ë˜ìŠ¤ë¥¼ êµ¬í˜„í• ê²ë‹ˆë‹¤(Web ìš”ì²­ì˜ ê°€ì¥ ìµœì „ì„ ì— ìˆëŠ” ë°±ì—”ë“œê°€ Controller í´ë˜ìŠ¤ë¼ê³  í–ˆìŠµë‹ˆë‹¤).

```java
package com.korit12.cardatabase.web;

import com.korit12.cardatabase.domain.AccountCredentials;
import com.korit12.cardatabase.service.JwtService;
import lombok.AllArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
@AllArgsConstructor
public class LoginController {
    private JwtService jwtService;
    private AuthenticationManager authenticationManager;

    // ë¡œê·¸ì¸ì´ë‹ˆê¹Œ POST ìš”ì²­ì´ì–´ì•¼ê² ë„¤ìš”.
    @PostMapping("/login")
    public ResponseEntity<?> getToken(@RequestBody AccountCredentials credentials) {
        // ì—¬ê¸°ì— í† í° ìƒì„±í•˜ê³  ì‘ë‹µì˜ Authorization í—¤ë”ë¡œ ì „ì†¡í•´ì£¼ëŠ” ë¡œì§ì„ ì‘ì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.
    }
}
```
- í•„ìš” í•™ìŠµ ë‚´ìš© ì •ë¦¬
1. ResponseEntity í´ë˜ìŠ¤
    - ì •ì˜
        - ResponseEntityëŠ” Springì—ì„œ HTTP ì‘ë‹µ ì „ì²´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í´ë˜ìŠ¤ë¡œ, ê·¸ë˜ì„œ Controller í´ë˜ìŠ¤ì—ì„œ ì“°ì…ë‹ˆë‹¤. ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ì—ì„œ ResponseEntity í´ë˜ìŠ¤ë¥¼ returní•˜ë©´, ê°œë°œìê°€ ì‘ë‹µì˜ ë°ì´í„°(Body), HTTP ìƒíƒœ ì½”ë“œ(Status Code), ê·¸ë¦¬ê³  HTTP headersë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì œì–´í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

        - RESTful API ì„¤ê³„ì—ì„œ ì„œë²„ì˜ ìƒíƒœë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì •í™•í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ë° í•„ìˆ˜ì .

    - ì£¼ìš” íŠ¹ì§• ë° êµ¬ì„± ìš”ì†Œ
        1. Body(ë³¸ë¬¸)
            - í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‹¤ì œë¡œ ì „ì†¡ë˜ëŠ” ë°ì´í„° ì œë„¤ë¦­ `<>`ìœ¼ë¡œ ì§€ì •ë¨.
            - `User` ê°ì²´, `List<Product>` ë“±(JSON í˜•íƒœë¡œ ë³€í™˜ë˜ì–´ ì „ì†¡ë¨. - postmanì—ì„œ ì°¨ ë“±ë¡í•  ë•Œ JSONìœ¼ë¡œ ë³´ëƒˆê³ , backendì—ì„œ Java ê°ì²´ë¡œ ë³€í™˜ëœ ë’¤ì— -> MariaDBì— ì €ì¥ëìŠµë‹ˆë‹¤).
        2. Status Code(ìƒíƒœì½”ë“œ)
            - ìš”ì²­ ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë‚˜íƒ€ë‚´ëŠ” 3 ìë¦¬ ìˆ«ì.
                1. HttpStatus.OK - 200
                2. HttpStatus.CREATED - 201
                3. HttpStatus.NOT_FOUND - 404
        3. Headers
            - ì‘ë‹µì— ëŒ€í•œ ì¶”ê°€ì ì¸ ë©”íƒ€ ë°ì´í„°
                1. HttpHeaders.CONTENT_TYPE
                2. HttpHeaders.AUTHORIZATION
                3. HttpHeaders.LOCATION
```java
package com.korit12.cardatabase.config;

import com.korit12.cardatabase.service.UserDetailsServiceImpl;
import lombok.AllArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
@AllArgsConstructor
public class SecurityConfig {
    private UserDetailsServiceImpl userDetailsService;

    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService);
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .csrf(csrf -> csrf.disable())
                .sessionManagement(sessionManagement
                        -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authorizeHttpRequests
                        -> authorizeHttpRequests.requestMatchers(HttpMethod.POST, "/login").permitAll().anyRequest().authenticated());
        return http.build();
    }
}
```
- ì´ìƒì—ì„œ ì£¼ëª©í•´ì•¼ í•  ë©”ì„œë“œëŠ” filterChain ë©”ì„œë“œì…ë‹ˆë‹¤. SecurityFilterChain ë¹ˆì€ ì–´ë–¤ ê²½ë¡œê°€ ë³´í˜¸ë˜ê³ , ì–´ë–¤ ê²½ë¡œê°€ ë³´í˜¸ë˜ì§€ ì•ŠëŠ”ì§€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ë©”ì„œë“œ ë‚´ë¶€ë¥¼ ë³´ì‹œë©´ "/login" ê²½ë¡œì˜ POST ìš”ì²­ì— ëŒ€í•´ì„œëŠ” permitAll()ì´ë¼ëŠ” ë©”ì„œë“œê°€ ë¶™ì–´ìˆìŠµë‹ˆë‹¤.
`authorizeHttpRequests.requestMatchers(HttpMethod.POST, "/login").permitAll().anyRequest().authenticated()` ê·¸ë˜ì„œ ì´ ì½”ë“œë¥¼ êµ³ì´ í•´ì„í•´ë³´ìë©´, /login ì—”ë“œí¬ì¸íŠ¸ì˜ POST ìš”ì²­ì— ëŒ€í•´ì„œëŠ” permitAll()ì´ê¸° ë•Œë¬¸ì— JWTê°€ ì—†ì–´ë„ ìš”ì²­ ê°€ëŠ¥. í•˜ì§€ë§Œ ë‚˜ë¨¸ì§€(anyRequest())ì˜ ê²½ìš°ì—ëŠ” ì¸ê°€(authenticated())ê°€ í•„ìš”.

ì´ìƒì˜ ê³¼ì •ì´ ëª¨ë‘ í•´ê²°ë˜ê²Œ ë˜ë©´ postmanì„ í†µí•´ì„œ login ìš”ì²­ì„ í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
![alt text](image-8.png)

ìš”ì²­ ê²°ê³¼ì˜ headersì˜ authorizationì„ í™•ì¸í•˜ê²Œ ë˜ë©´ Bearer + í† í° í˜•íƒœì˜ ë°ì´í„°ê°€ ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¦‰, ë¡œê·¸ì¸ ìš”ì²­ì´ ì„±ê³µí–ˆê¸° ë•Œë¬¸ì— JwtServiceì— ìˆëŠ” getToken() ë©”ì„œë“œì˜ í˜¸ì¶œì´ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì¡Œë‹¤ê³  ë³¼ ìˆ˜ ìˆê² ìŠµë‹ˆë‹¤.

## ë‹¤ë¥¸ ìš”ì²­ë“¤ ë³´í˜¸í•˜ê¸°

1. ë£¨íŠ¸ íŒ¨í‚¤ì§€ì— AuthenticationFilter í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤. ì–˜ëŠ” Spring Security ìƒì—ì„œì˜ OncePerRequestFilter ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¥ êµ¬í˜„í•˜ì—¬ ì¸ì¦ì„ ì“°ëŠ” doFilterInternal ë©”ì„œë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
```java
package com.korit12.cardatabase;

import com.korit12.cardatabase.service.JwtService;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.AllArgsConstructor;
import org.springframework.http.HttpHeaders;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.Collections;

@Component
@AllArgsConstructor
public class AuthenticationFilter extends OncePerRequestFilter {
    private JwtService jwtService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        // í† í° ê²€ì¦ ë° ì‚¬ìš©ì ê°€ì ¸ì˜¤ê¸°
        String jws = request.getHeader(HttpHeaders.AUTHORIZATION);
        if(jws != null) {
            String user = jwtService.getAuthUser(request);
            // ì¸ì¦í•˜ê¸°
            Authentication authentication = new UsernamePasswordAuthenticationToken(user, null, Collections.emptyList());

            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        filterChain.doFilter(request, response);
    }
}
```
- SecurityContextHolderëŠ” ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ì¸ì¦ëœ ì‚¬ìš©ìì˜ ì„¸ë¶€ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ê³³ì— í•´ë‹¹í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ì´ í´ë˜ìŠ¤ì—ì„œ doFilter()ë¼ëŠ” ë©”ì„œë“œë¥¼ ì •ì˜í•´ë’€ëŠ”ë°, ì´ë¥¼ í˜¸ì¶œí•˜ëŠ” ë‹¨ê³„ë¥¼ ìƒê°í•˜ì…”ì•¼ í•©ë‹ˆë‹¤. -> ìš”ì²­ì„ ë‚ ë¦´ ë•Œ ë§ˆë‹¤ í™•ì¸í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— SecurityConfig í´ë˜ìŠ¤ì˜ filterChain() ë©”ì„œë“œ ë‚´ì—ì„œ ì‚¬ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

```java
package com.korit12.cardatabase.config;

import com.korit12.cardatabase.AuthenticationFilter;
import com.korit12.cardatabase.service.UserDetailsServiceImpl;
import lombok.AllArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@AllArgsConstructor
public class SecurityConfig {
    private UserDetailsServiceImpl userDetailsService;
    private AuthenticationFilter authenticationFilter;

    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService);
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .csrf(csrf -> csrf.disable())
                .sessionManagement(sessionManagement
                        -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authorizeHttpRequests
                        -> authorizeHttpRequests.requestMatchers(HttpMethod.POST, "/login").permitAll().anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class);
        return http.build();
    }
}

```

private AuthenticationFilter authenticationFilter; ì¶”ê°€í–ˆìŠµë‹ˆë‹¤ -> AllArgsConstructor ë•Œë¬¸ì— ìë™ìœ¼ë¡œ ìƒì„±ìê°€ ê°±ì‹ ë©ë‹ˆë‹¤.


ê·¸ë¦¬ê³  `.addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class);` ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

## ì˜ˆì™¸ ì²˜ë¦¬í•˜ê¸°
- í˜„ì¬ ì˜ëª»ëœ ì•”í˜¸ë¥¼ ì´ìš©í•˜ì—¬ ë¡œê·¸ì¸ì„ ì‹œë„í–ˆì„ ê²½ìš°ë¥¼ ìƒì •í•˜ê² ìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” 403ìœ¼ë¡œ ë‚˜ì˜¤ê¸°ë§Œ í•©ë‹ˆë‹¤. Basic Auth ì´ìš©í–ˆì„ ë•ŒëŠ” 401ì´ë¼ê³  ì•ˆë‚´í–ˆì—ˆëŠ”ë° ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì ì ˆí•œ ë¡œê·¸ê°€ ì•ˆë‚´ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í˜‘ì—… ì‹œì— ë¬¸ì œê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ 401ì´ ëœ¨ë„ë¡ ì»¤ìŠ¤í…€í•˜ê² ìŠµë‹ˆë‹¤.

1. ë£¨íŠ¸ íŒ¨í‚¤ì§€ì— AuthenticationEntryPointë¥¼ _êµ¬í˜„_ í•˜ëŠ” AuthEntryPoint í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤. implements ë°›ê³  ë»˜ê±´ ì¤„ ì—¬ëŸ¬ë¶„ë“¤ì´ ì—†ì• ë³´ê² ìŠµë‹ˆë‹¤.

![alt text](image-9.png)
403 -> 401ë¡œ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤. : `response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);` ë¡œ ì €í¬ê°€ ì»¤ìŠ¤í…€í•´ë’€ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
ê·¸ë¦¬ê³  ì›ë˜ ë¡œê·¸ì¸ ì‹¤íŒ¨ì‹œì—ëŠ” body ë€ì— ì•„ë¬´ ê²ƒë„ ëœ¨ì§€ ì•Šì•˜ëŠ”ë°, Error: ?? ??? ì–´ì©Œê³  ë– ìˆìŠµë‹ˆë‹¤.
ì–˜ëŠ”
`writer.println("Error : " + authException.getMessage());` ì´ê±° ë•Œë¬¸ì´ê² ë„¤ìš”. ì¦‰, writer ê°ì²´ë¥¼ ìƒì„±í•´ì„œ print ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì˜¤ë¥˜ ë¡œê·¸ì— ëŒ€í•œ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ JSONìœ¼ë¡œ ë°›ì•„ë³¼ ìˆ˜ ìˆê²Œë” ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

## CORS í•„í„° ì¶”ê°€í•˜ê¸°
CORS(Cross Origin Resources Sharing)ëŠ” í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°€ êµì°¨ ì¶œì²˜(source) ì¬ìš”ì²­ì„ í—ˆìš©í•˜ê²Œ í•  ì§€ ê±°ë¶€í• ì§€ë¥¼ ê²°ì •í•˜ê²Œ í•˜ëŠ” íŠ¹ì • í—¤ë”ë¥¼ ë„ì…í•©ë‹ˆë‹¤. backend:8080 / front:5173ë¡œ ê¸°ë³¸ í• ë‹¹ì´ ë˜ëŠ”ë° ë°±-í”„ë¡ íŠ¸ê°€ ì„œë¡œ í†µì‹ í•˜ëŠ” ê³¼ì • ìƒì—ì„œ ìš”ì²­ ê±°ë¶€ê°€ ìì£¼ ì¼ì–´ë‚©ë‹ˆë‹¤.

CORS í•„í„°ëŠ” ë‹¤ë¥¸ ì¶œì²˜ì—ì„œ ìš”ì²­ì„ ë³´ë‚´ëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í•„ìš”í•©ë‹ˆë‹¤. CORSëŠ” ìš”ì²­ì„ ê°€ë¡œì±„ê³ (intercept), êµì°¨ ì¶œì²˜ë¡œ ì‹ë³„ë˜ë©´(ì„œë¡œ ì—°ê²°ê´€ê³„ê°€ ìˆë‹¤ë©´) ìš”ì²­ì— ì ì ˆí•œ headerë¥¼ ì¶”ê°€í•´ì¤ë‹ˆë‹¤.

- Spring Securityì˜ CorsConfigurationSource ì¸í„°í˜ì´ìŠ¤ë¥¼ ì´ìš©í• ê²ë‹ˆë‹¤.

- ì €í¬ ì˜ˆì œì—ì„œëŠ” ëª¨ë“  ì¶œì²˜ì˜ HTTP ë©”ì„œë“œì™€ í—¤ë”ë¥¼ í—ˆìš©í•˜ê²Œë” ì‘ì„±í• ê²ë‹ˆë‹¤. ë‚˜ì¤‘ì— ì—¬ëŸ¬ë¶„ë“¤ì˜ í”„ë¡œì íŠ¸ì— ë”°ë¼ ì»¤ìŠ¤í…€ì´ ìš”êµ¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java
package com.korit12.cardatabase.config;

import com.korit12.cardatabase.AuthEntryPoint;
import com.korit12.cardatabase.AuthenticationFilter;
import com.korit12.cardatabase.service.UserDetailsServiceImpl;
import lombok.AllArgsConstructor;
import org.jspecify.annotations.NonNull;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import java.util.Arrays;

import static org.springframework.security.config.Customizer.withDefaults;

@Configuration
@EnableWebSecurity
@AllArgsConstructor
public class SecurityConfig {
    private UserDetailsServiceImpl userDetailsService;
    private AuthenticationFilter authenticationFilter;
    private AuthEntryPoint exceptionHandler;

    public void configureGlobal(@NonNull AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService);
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
                .csrf(csrf -> csrf.disable())
                .cors(withDefaults())
                .sessionManagement(sessionManagement
                        -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authorizeHttpRequests
                        -> authorizeHttpRequests.requestMatchers(HttpMethod.POST, "/login").permitAll().anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling(exceptionHandling
                        -> exceptionHandling.authenticationEntryPoint(exceptionHandler));
        return http.build();
    }

    // í´ë˜ìŠ¤ ë‚´ì— ì „ì—­ CORS í•„í„° ì¶”ê°€
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        CorsConfiguration config = new CorsConfiguration();
        config.setAllowedOrigins(Arrays.asList("*"));
        config.setAllowedMethods(Arrays.asList("*"));
        config.setAllowedHeaders(Arrays.asList("*"));
        config.setAllowCredentials(false);
        config.applyPermitDefaultValues();
        
        source.registerCorsConfiguration("/**", config);
        
        return source;
    }
}
```
íŠ¹ì • urlì— ëŒ€í•´ì„œë§Œ ìš”ì²­ì„ í—ˆìš©í•˜ë ¤ë©´ `config.setAllowedOrigins(Arrays.asList("*"));` ë¶€ë¶„ì„ ìˆ˜ì •í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
`config.setAllowedOrigins(Arrays.asList("http://localhost:5173"));`


# Role-based Security

Spring Securityì—ì„œëŠ” ì—­í• ì„ ì´ìš©í•˜ì—¬ ì„¸ë¶„í™”ëœ ì—­í•  ê¸°ë°˜ ë³´ì•ˆì„ ì •ì˜í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë©°, ì‚¬ìš©ìëŠ” í•˜ë‚˜ í˜¹ì€ ì—¬ëŸ¬ ê°œì˜ ì—­í• ì— í• ë‹¹ë˜ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—­í• ì€ í”íˆ ADMIN, MANAGER, USER ê°™ì€ ê³„ì¸µ êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ í‚¤ì˜¤ìŠ¤í¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í–ˆì„ ë•Œ, ìŒë£Œ ì£¼ë¬¸í•œë‹¤ë©´ ë¹„íšŒì›ì€ ì—­í• ì´ ì—†ê±°ë‚˜ USERì— í•´ë‹¹ë  ê²ƒì´ê³ , ê°€ë§¹ì ì£¼ëŠ” MANAGERì¼ê²ë‹ˆë‹¤. ê·¸ë¦¬ê³  ê°€ë” ìˆ˜ë¦¬í•˜ëŸ¬ ì˜¤ê±°ë‚˜ ë³¸ì‚¬ ì‚¬ëŒì€ ADMINì´ ë˜ê² ë„¤ìš”. ì´ ë•Œ ADMINì€ MANAGERì˜ ê¶Œí•œ ëŒ€ë¶€ë¶„ì„ ê°€ì§ˆ ìˆ˜ ìˆë‹¤ëŠ” ì ì—ì„œ ê³„ì¸µì ì´ë¼ê³  í•  ê²ë‹ˆë‹¤.

ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ë¥¼ SecurityConfig ì—ì„œ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´í•˜ì˜ ì˜ˆì‹œì—ì„œ íŠ¹ì • ì—­í• ì´ í•„ìš”í•œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë”°ë¡œ ì •ì˜í• ê²ë‹ˆë‹¤. `/admin/**`ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•˜ë ¤ë©´ ADMIN ì—­í• ì„ ê°€ì§€ê³  ìˆê³ , `/user/**`ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•˜ë ¤ë©´ USER ì—­í• ì„ í•„ìš”í•˜ê²Œë” í•˜ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤.

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
      .csrf(csrf -> csrf.disable())
      .cors(withDefaults())
      .sessionManagement(sessionManagement
              -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
      .authorizeHttpRequests(authorizeHttpRequests
              -> authorizeHttpRequests.requestMatchers("/admin/**").hasRole("ADMIN").requestMatchers("/user/**").hasRole("USER").anyRequest().authenticated())
      .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
      .exceptionHandling(exceptionHandling
              -> exceptionHandling.authenticationEntryPoint(exceptionHandler));
    return http.build();
}
```